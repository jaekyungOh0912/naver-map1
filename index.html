<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€ë„ í…ŒìŠ¤íŠ¸</title>
  <!-- ë„¤ì´ë²„ ì§€ë„, í´ëŸ¬ìŠ¤í„°ë§, ë°ì´í„° -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=n08un8adzv&submodules=geocoder"></script>
  <script src="./MarkerClustering.js"></script>
  <script src="./markerData.js"></script>
  <script src="./sigunguData.js"></script>
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° UI ìŠ¤íƒ€ì¼ */
    body { margin: 0; padding: 0; }
    button { outline: none; cursor: pointer; }
    .searchBox { width:100%;height:70px;background:#E5EDF8;position:fixed;top:0;left:0;z-index:999; }
    .searchBox .searchInputBox { width:calc(100% - 20px);max-width:340px;height:50px;background:#fff;margin:8px auto 0;display:flex;overflow:hidden; }
    .searchBox .searchInputBox input { width:calc(100% - 55px);height:50px;padding:0 5px;border:none;box-sizing:border-box; }
    .searchBox .searchInputBox button { width:50px;height:50px;border:none;background:transparent; }
    .searchBox ul { width:calc(100% - 20px);max-width:340px;max-height:150px;list-style:none;padding:0;margin:5px 0 0 0;overflow-y:auto;background:#fff;border:1px solid #ccc;position:fixed;top:55px;left:50%;transform:translateX(-50%);}
    .searchBox li { padding:10px 8px;cursor:pointer;font-size:14px;border-bottom:1px solid #DDD; }
    .searchBox li:hover { background:#f0f0f0; }
    #map { width:100dvw; height:100dvh; }
    .filterBox { position:fixed;top:10dvh;right:25px; }
    .filterBox button { width:60px;height:60px;display:block;margin-top:10px;font-size:12px; }
    .filterBox button:nth-child(1) { margin-top:0; }
    .filterBox button.active { background:red;color:white; }
    .controlBox { position:fixed;top:10dvh;left:25px; }
    .controlBox button { width:60px;height:60px;display:block;margin-top:10px;font-size:12px; }
    .controlBox button:nth-child(1) { margin-top:0; }
    .addressBox { position:fixed;top:80px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.9);padding:8px 14px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);font-size:14px;color:#333;z-index:998;}
    #mapComponent.hide .searchBox,
    #mapComponent.hide .filterBox,
    #mapComponent.hide .controlBox,
    #mapComponent.hide .addressBox { display:none; }
  </style>
</head>
<body>
<div id="mapComponent">
  <!-- ì£¼ì†Œ ê²€ìƒ‰ ë°•ìŠ¤ -->
  <div class="searchBox">
    <div class="searchInputBox">
      <input type="text" id="searchInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button onclick="searchAddress()"><img src="image/search.png" alt="ê²€ìƒ‰"></button>
    </div>
    <ul id="searchResults"></ul>
  </div>

  <!-- ì§€ë„ ì˜ì—­ -->
  <div id="map"></div>

  <!-- í˜„ì¬ ì£¼ì†Œ í‘œì‹œ -->
  <div class="addressBox" id="addressBox">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- í•„í„° ë²„íŠ¼ -->
  <div class="filterBox">
    <button class="active" onclick="handleFilterChange(0)">ì „ì²´</button>
    <button onclick="handleFilterChange(1)">ì•„íŒŒíŠ¸</button>
    <button onclick="handleFilterChange(2)">ì˜¤í”¼ìŠ¤í…”</button>
    <button onclick="handleFilterChange(3)">ì—°ë¦½,ë‹¤ì„¸ëŒ€</button>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
  <div class="controlBox">
    <button onclick="goMyLocation()">ğŸ“</button>
    <button onclick="zoomIn()">ï¼‹</button>
    <button onclick="zoomOut()">ï¼</button>
  </div>
</div>

<script>
  /* -------------------------------
     âœ… ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ì„¤ì •
  --------------------------------*/
  let markerDataList = markerData;       // ê¸°ë³¸ ë§ˆì»¤ ë°ì´í„°
  const map = new naver.maps.Map('map', { // ì§€ë„ ì´ˆê¸°í™”
    center: new naver.maps.LatLng(35.144, 129.060),
    zoom: 16, minZoom:7, maxZoom:19
  });
  const addressBox = document.getElementById("addressBox");

  const loadedEmdCodes = [];    // ì´ë¯¸ ë¡œë“œëœ í–‰ì •ë™ ì½”ë“œ
  const polygonCache = {};      // í´ë¦¬ê³¤ ìºì‹±
  let cluster = null;           // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°
  let activePolygon = null;     // í˜„ì¬ í™œì„±í™”ëœ í´ë¦¬ê³¤
  let dataList = [];            // í˜„ì¬ ì§€ë„ì— í‘œì‹œí•  ë°ì´í„°
  let currentEmdData = null;    // í˜„ì¬ í–‰ì •ë™ ë°ì´í„°
  const markers = [];           // ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ëª©ë¡

  /* -------------------------------
     âœ… ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© (í–‰ì •ë™ ë°ì´í„°)
  --------------------------------*/
  function loadEmdScript(code, callback) {
    // ì´ë¯¸ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë©´ ì½œë°±ë§Œ ì‹¤í–‰
    if (window["emd_" + code]) {
      if (!loadedEmdCodes.includes(code)) loadedEmdCodes.push(code);
      callback && callback();
      return;
    }
    // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
    if (loadedEmdCodes.includes(code)) {
      callback && callback();
      return;
    }
    // ìƒˆë¡œìš´ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
    const script = document.createElement("script");
    script.src = `./dongData/emd_${code}.js`;
    script.onload = () => {
      loadedEmdCodes.push(code);
      callback && callback();
    };
    document.body.appendChild(script);
  }

  /* -------------------------------
     âœ… ì£¼ì†Œ ë³€í™˜ ë° ê²€ìƒ‰
  --------------------------------*/
  // í˜„ì¬ ì¤‘ì‹¬ ì¢Œí‘œì˜ ì£¼ì†Œ ê°±ì‹ 
  function updateAddress(lat, lng) {
    naver.maps.Service.reverseGeocode({
      coords: new naver.maps.LatLng(lat, lng),
      orders: [naver.maps.Service.OrderType.ROAD_ADDR, naver.maps.Service.OrderType.ADDR].join(',')
    }, (status, response) => {
      if (status !== naver.maps.Service.Status.OK) {
        addressBox.innerText = "ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return;
      }
      const result = response.v2.address;
      addressBox.innerText = "ğŸ“ " + (result.roadAddress || result.jibunAddress || "ì£¼ì†Œ ì—†ìŒ");
    });
  }

  // ì£¼ì†Œ ê²€ìƒ‰
  function searchAddress() {
    const query = document.getElementById("searchInput").value.trim();
    if (!query) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    const cleanQuery = query.replace(/[^ê°€-í£0-9a-zA-Z\s]/g, "").trim();
    naver.maps.Service.geocode({ query: cleanQuery }, (status, response) => {
      if (status !== naver.maps.Service.Status.OK) return alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");

      const resultList = response.v2.addresses;
      const resultBox = document.getElementById("searchResults");
      resultBox.innerHTML = "";

      if (!resultList.length) {
        resultBox.innerHTML = "<li style='padding:4px 6px;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>"; return;
      }

      resultList.forEach(addr => {
        const fullAddr = addr.roadAddress || addr.jibunAddress || "(ì£¼ì†Œ ì—†ìŒ)";
        if (!fullAddr.includes(query) && !fullAddr.replace(/\s/g, "").includes(query.replace(/\s/g, ""))) return;

        // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ì§€ë„ ì´ë™
        const li = document.createElement("li");
        li.innerText = fullAddr;
        li.addEventListener("click", () => {
          const x = parseFloat(addr.x), y = parseFloat(addr.y);
          const newCenter = new naver.maps.LatLng(y, x);
          map.setCenter(newCenter); map.setZoom(16);
          new naver.maps.Marker({ position: newCenter, map: map });
          updateAddress(y, x);
          resultBox.innerHTML = "";
          document.getElementById("searchInput").value = "";
        });
        resultBox.appendChild(li);
      });
    });
  }

  /* -------------------------------
     âœ… ë§ˆì»¤ ê´€ë ¨
  --------------------------------*/
  const infoWindow = new naver.maps.InfoWindow({
    borderWidth:0, disableAnchor:true, backgroundColor:"transparent",
    pixelOffset:new naver.maps.Point(0,-10)
  });

  // ë§ˆì»¤ ìƒì„±
  function setMarkers(lat,lng,type,name,price,count,active){
    const countHTML = (count && count>0)
      ? `<div style="position:absolute;top:-5px;right:-5px;width:18px;height:18px;background:red;color:white;font-size:11px;font-weight:bold;text-align:center;line-height:18px;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,0.3);">${count}</div>` : "";
    const activeHTML = (!active) ? "<div style=\"position:absolute;top:-5px;left:-5px;width:18px;height:18px;background:gray;color:white;font-size:11px;font-weight:bold;text-align:center;line-height:18px;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,0.3);\"></div>" : "";
    const markerHTML = `<div style="position:relative;width:30px;height:30px;"><img src="./image/type${type}.png" style="width:30px;height:30px;"/>${countHTML}${activeHTML}</div>`;
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat,lng),
      icon:{content:markerHTML,size:new naver.maps.Size(30,30),scaledSize:new naver.maps.Size(30,30)}
    });
    // ë§ˆì»¤ í´ë¦­ ì‹œ InfoWindow í‘œì‹œ
    if (active) {
      naver.maps.Event.addListener(marker,"click",()=>{
        infoWindow.setContent(
          `<div style="background:#fff;border:1px solid #ccc;border-radius:8px;padding:10px;width:150px;box-shadow:0 2px 6px rgba(0,0,0,0.2);font-size:13px;">
          <div style="font-weight:bold;color:#333;margin-bottom:4px;">${name}</div>
          <div style="color:#d9534f;font-weight:bold;">${price.toLocaleString()}ì›</div>
          <button style="margin-top:6px;width:100%;background:#007bff;color:#fff;border:none;border-radius:4px;padding:4px;cursor:pointer;">ìƒì„¸ë³´ê¸°</button>
        </div>`
        );
        infoWindow.open(map,marker);
      });
    }

    naver.maps.Event.addListener(map,"click",()=>infoWindow.close());
    markers.push(marker);
  }

  function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers.length=0; }
  function renderMarkers(list){ clearMarkers(); list.forEach(v=>setMarkers(v.lat,v.lng,v.type,v.name||"ê±´ë¬¼ëª… ì—†ìŒ",v.price||0,v.count,v.active)); }

  /* -------------------------------
     âœ… í´ë¦¬ê³¤ ë° í´ëŸ¬ìŠ¤í„°
  --------------------------------*/
  function createPolygon(feature){
    const key = feature.properties.EMD_CD || JSON.stringify(feature.geometry);
    if (polygonCache[key]) return polygonCache[key];

    const paths = [];
    if(feature.geometry.type==="Polygon"){
      feature.geometry.coordinates.forEach(ring=>paths.push(ring.map(([lng,lat])=>new naver.maps.LatLng(lat,lng))));
    } else {
      feature.geometry.coordinates.forEach(poly=>poly.forEach(ring=>paths.push(ring.map(([lng,lat])=>new naver.maps.LatLng(lat,lng)))));
    }

    const polygon = new naver.maps.Polygon({
      paths, fillColor:'#FE7E33', fillOpacity:0.1, strokeColor:'#FE7E33',
      strokeOpacity:1, strokeWeight:2, clickable:false
    });
    polygonCache[key] = polygon;
    return polygon;
  }

  function isPointInsidePolygon(point,paths){
    const x=point.lng(),y=point.lat(); let inside=false;
    paths.forEach(path=>{
      for(let i=0,j=path.length-1;i<path.length;j=i++){
        const xi=path[i].lng(),yi=path[i].lat(),xj=path[j].lng(),yj=path[j].lat();
        const intersect=((yi>y)!==(yj>y))&&(x<(xj-xi)*(y-yi)/((yj-yi)||1e-10)+xi);
        if(intersect) inside=!inside;
      }
    });
    return inside;
  }

  function filterMarkersByEmdPolygon(){
    if(!currentEmdData||!currentEmdData.features) return [];
    const polygons = currentEmdData.features.map(f=>createPolygon(f).getPaths().getArray().map(path=>path.getArray()));
    return markerDataList.filter(m=>{
      const markerPos=new naver.maps.LatLng(m.lat,m.lng);
      return polygons.some(paths=>isPointInsidePolygon(markerPos,paths));
    });
  }

  function renderRegionAtCenter(center){
    if(activePolygon) activePolygon.setMap(null);
    activePolygon = null;
    for(const feature of dataList){
      const polygon=createPolygon(feature);
      const paths=polygon.getPaths().getArray().map(path=>path.getArray());
      if(isPointInsidePolygon(center,paths)){
        polygon.setMap(map); activePolygon=polygon; break;
      }
    }
    updateMarkersByPolygon();
  }

  function updateMarkersByPolygon(){
    if(!activePolygon){ if(cluster) cluster.setMap(null); return; }
    const paths=activePolygon.getPaths().getArray().map(path=>path.getArray());
    const visibleMarkers=markers.filter(m=>isPointInsidePolygon(m.getPosition(),paths));
    if(cluster) cluster.setMap(null);
    cluster = new MarkerClustering({
      map, markers:visibleMarkers, disableClickZoom:false, gridSize:300,
      minClusterSize:1, maxZoom:18, icons:clusterIcons,
      indexGenerator:[10,100,200,500,1000],
      stylingFunction:(c,count)=>{c.getElement().querySelector('div:first-child').innerText=count;}
    });
  }

  /* -------------------------------
     âœ… ì§€ë„ ì¤‘ì‹¬ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ (Debounce)
  --------------------------------*/
  let regionUpdateTimer=null;
  function applyRegionUpdate(emdCode){
    currentEmdData=window["emd_"+emdCode]||null;
    const zoom=map.getZoom();
    if(zoom>14) dataList=currentEmdData?currentEmdData.features:[];
    else if(zoom>11) dataList=sigunguGeoJson.features;
    else dataList=[];
    const filteredMarkers=(zoom>14&&currentEmdData)?filterMarkersByEmdPolygon():markerDataList;
    renderMarkers(filteredMarkers);
    renderRegionAtCenter(map.getCenter());
  }

  function updateRegionByCenter(){
    clearTimeout(regionUpdateTimer);
    regionUpdateTimer = setTimeout(()=>{
      const center=map.getCenter();
      naver.maps.Service.reverseGeocode({
        coords:center,
        orders:[naver.maps.Service.OrderType.ADDR,naver.maps.Service.OrderType.ROAD_ADDR].join(',')
      },(status,response)=>{
        if(status!==naver.maps.Service.Status.OK)return;
        const result=response.v2.results[0]; if(!result)return;
        const emdCode=result.code.id.slice(0,2);
        if(window["emd_"+emdCode]) applyRegionUpdate(emdCode);
        else loadEmdScript(emdCode,()=>applyRegionUpdate(emdCode));
      });
    },300); // 300ms ì§€ì—° â†’ ë¶ˆí•„ìš”í•œ ì—°ì† í˜¸ì¶œ ë°©ì§€
  }

  /* -------------------------------
     âœ… ê¸°íƒ€ UI/ê¸°ëŠ¥
  --------------------------------*/
  let myLocationMarker=null;
  function goMyLocation(){
    if(!navigator.geolocation)return;
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      const loc=new naver.maps.LatLng(lat,lng);
      if(!myLocationMarker){
        myLocationMarker=new naver.maps.Marker({
          position:loc,map:map,
          icon:{url:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
            size:new naver.maps.Size(32,32),scaledSize:new naver.maps.Size(32,32)}
        });
      } else myLocationMarker.setPosition(loc);
      map.setCenter(loc); map.setZoom(16);
      updateAddress(lat,lng);
    },()=>{addressBox.innerText="ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";});
  }

  function zoomIn(){ map.setZoom(map.getZoom()+1); }
  function zoomOut(){ map.setZoom(map.getZoom()-1); }

  function handleFilterChange(type){
    const filterBtn=document.querySelectorAll(".filterBox button");
    filterBtn.forEach((el,idx)=>el.classList.toggle("active",type===idx));
    markerDataList=(type===0)?markerData:markerData.filter(v=>v.type===type);
    updateRegionByCenter();
  }

  naver.maps.Event.addListener(map,'idle',updateRegionByCenter);
  naver.maps.Event.addListener(map,'zoom_changed',()=>{updateClusterIconsByZoom();updateRegionByCenter();});
  window.addEventListener("load",()=>{goMyLocation();updateRegionByCenter();});

  naver.maps.Event.addListener(map,"click",()=>{
    document.getElementById("mapComponent").classList.toggle("hide");
  });

  function getBaseIcon(size){
    return {
      content:`<div style="cursor:pointer;width:${size}px;height:${size}px;line-height:${size+2}px;font-size:${Math.max(12,size/3)}px;color:white;text-align:center;font-weight:bold;background:url(./image/baseIcon.png);background-size:contain;"></div>`,
      size:new naver.maps.Size(size,size),
      anchor:new naver.maps.Point(size/2,size/2)
    };
  }
  function updateClusterIconsByZoom(){
    const zoom=map.getZoom(),defaultZoom=16-zoom;
    let iconSize=(defaultZoom>0)?50+(15*defaultZoom):50;
    clusterIcons=[1,2,3,4,5].map(()=>getBaseIcon(iconSize));
    if(cluster) updateMarkersByPolygon();
  }
  let clusterIcons=[1,2,3,4,5].map(()=>getBaseIcon(40));
</script>
</body>
</html>
