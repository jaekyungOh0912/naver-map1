<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏßÄÎèÑ ÌÖåÏä§Ìä∏</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=n08un8adzv&submodules=geocoder"></script>
  <script src="./MarkerClustering.js"></script>
  <script src="./markerData.js"></script>
  <script src="./sigunguData.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    button { outline: none; cursor: pointer; }

    .searchBox {
      width: 100%; height: 70px; background-color: #E5EDF8;
      position: fixed; top: 0; left: 0;
      z-index: 999;
    }
    .searchBox .searchInputBox {
      width: calc(100% - 20px); max-width: 340px; height: 50px;
      background-color: #FFFFFF;
      margin: 8px auto 0;
      display: flex; align-content: space-between; justify-items: center;
      overflow: hidden;
    }
    .searchBox .searchInputBox input {
      width: calc(100% - 55px); height: 50px;
      padding: 0 5px; border: none; box-sizing: border-box;
    }
    .searchBox .searchInputBox button {
      width: 50px; height: 50px;
      margin: 0; padding: 0; border: none;
      background-color: transparent;
    }

    .searchBox ul {
      width: calc(100% - 20px); max-width: 340px; max-height: 150px;
      list-style: none;
      padding: 0;
      margin: 5px 0 0 0;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      position: fixed;
      top: 55px;
      left: 50%;
      transform: translateX(-50%);
    }
    .searchBox li {
      padding: 10px 8px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #DDD;
    }
    .searchBox li:hover {
      background: #f0f0f0;
    }

    #map { width:100dvw; height:100dvh; }

    .filterBox {
      position: fixed; top: 10dvh; right: 25px;
    }
    .filterBox button {
      width: 60px; height: 60px; display: block;
      margin-top: 10px; font-size: 12px;
    }
    .filterBox button:nth-child(1) { margin-top: 0; }
    .filterBox button.active { background-color: red; color: white; }

    .controlBox {
      position: fixed; top: 10dvh; left: 25px;
    }
    .controlBox button {
      width: 60px; height: 60px; display: block;
      margin-top: 10px; font-size: 12px;
    }
    .controlBox button:nth-child(1) { margin-top: 0; }

    .addressBox {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 8px 14px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: 14px;
      color: #333;
      z-index: 998;
    }

    #mapComponent.hide .searchBox,
    #mapComponent.hide .filterBox,
    #mapComponent.hide .controlBox,
    #mapComponent.hide .addressBox {
      display: none;
    }
  </style>
</head>
<body>
<div id="mapComponent">
  <div class="searchBox">
    <div class="searchInputBox">
      <input type="text" id="searchInput" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
      <button onclick="searchAddress()">
        <img src="image/search.png" alt="Í≤ÄÏÉâ">
      </button>
    </div>
    <ul id="searchResults"></ul>
  </div>
  <div id="map"></div>

  <div class="addressBox" id="addressBox">Ï£ºÏÜåÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>

  <div class="filterBox">
    <button class="active" onclick="handleFilterChange(0)">Ï†ÑÏ≤¥</button>
    <button onclick="handleFilterChange(1)">ÏïÑÌååÌä∏</button>
    <button onclick="handleFilterChange(2)">Ïò§ÌîºÏä§ÌÖî</button>
    <button onclick="handleFilterChange(3)">Ïó∞Î¶Ω,Îã§ÏÑ∏ÎåÄ</button>
  </div>

  <div class="controlBox">
    <button onclick="goMyLocation()">üìç</button>
    <button onclick="zoomIn()">Ôºã</button>
    <button onclick="zoomOut()">Ôºç</button>
  </div>
</div>

<script>
  let markerDataList = markerData;
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(35.144, 129.060),
    zoom: 16,
    minZoom: 7,
    maxZoom: 19
  });

  const addressBox = document.getElementById("addressBox");

  // ‚úÖ ÏãúÎèÑÎ≥Ñ Îèô Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò
  async function loadDongDataBySido(sidoCode) {
    return new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = `./dongData/emd_${sidoCode}.js`;
      script.onload = () => {
        const dataVar = window[`emd_${sidoCode}`];
        if (dataVar) resolve(dataVar.features);
        else reject(`emd_${sidoCode}.js Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`);
      };
      script.onerror = () => reject(`emd_${sidoCode}.js Î°úÎìú Ïã§Ìå®`);
      document.body.appendChild(script);
    });
  }

  // ‚úÖ Í∏∞Î≥∏ ÏÑúÏö∏ÌäπÎ≥ÑÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  let dataList = [];
  async function initDongData() {
    try {
      dataList = await loadDongDataBySido("11"); // Í∏∞Î≥∏Í∞í: ÏÑúÏö∏
      refreshMapData();
    } catch (e) {
      console.error(e);
      alert("ÌñâÏ†ïÎèô Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
    }
  }

  // ‚úÖ ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÌõÑ Îèô Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  window.addEventListener("load", () => {
    goMyLocation();
    initDongData();
  });

  // ‚úÖ Ïù¥Ìïò Í∏∞Ï°¥ ÏΩîÎìú ÎèôÏùº (dongGeoJson ÎåÄÏã† dataList ÏÇ¨Ïö©)
  // ... Í∏∞Ï°¥ updateAddress, searchAddress, goMyLocation, setMarkers, createPolygon, updateMarkersByPolygon Îì± Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ ...

  function refreshMapData() {
    renderRegionAtCenter(map.getCenter());
  }

  function renderRegionAtCenter(center) {
    if (activePolygon) activePolygon.setMap(null);
    activePolygon = null;
    for (const feature of dataList) {
      const polygon = createPolygon(feature);
      const paths = polygon.getPaths().getArray().map(path => path.getArray());
      if (isPointInsidePolygon(center, paths)) {
        polygon.setMap(map);
        activePolygon = polygon;
        break;
      }
    }
    updateMarkersByPolygon();
  }
</script>
</body>
</html>
